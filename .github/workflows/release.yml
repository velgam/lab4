name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write  # â† Ð­Ð¢Ð Ð¡Ð¢Ð ÐžÐšÐ Ð’ÐÐ–ÐÐ!
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸš€ Deploying: $VERSION"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð²ÐµÑ€ÑÐ¸Ð¸
          mkdir -p "versions/$VERSION"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -r en/ ru/ index.html "versions/$VERSION/"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
          echo "âœ… Files in versions/$VERSION/:"
          ls -la "versions/$VERSION/"
          
      - name: Update versions list
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸ“ Updating versions.json"
          
          if [ ! -f versions.json ]; then
            echo '[]' > versions.json
          fi
          
          node -e "
          const fs = require('fs');
          let versions = [];
          try {
            versions = JSON.parse(fs.readFileSync('versions.json'));
          } catch(e) {}
          
          if (!versions.find(v => v.name === '$VERSION')) {
            versions.unshift({
              name: '$VERSION',
              url: 'versions/$VERSION',
              date: new Date().toISOString()
            });
            console.log('âœ… Added version: $VERSION');
          }
          
          fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
          console.log('Total versions:', versions.length);
          "
          
      - name: Upload and deploy
        uses: actions/upload-pages-artifact@v3
        with: 
          path: .
          
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4