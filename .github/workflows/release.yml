name: Deploy to GitHub Pages on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create version folder
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üöÄ Creating version: $VERSION_NAME"
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
        mkdir -p "versions/$VERSION_NAME"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        cp -r en ru index.html "versions/$VERSION_NAME/"
        echo "‚úÖ Files copied to versions/$VERSION_NAME"

    - name: Fix HTML links
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üîß Fixing links for: $VERSION_NAME"
        
        # –†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è
        sed -i 's|href="/lab4/|href="/lab4/versions/'$VERSION_NAME'/|g' "versions/$VERSION_NAME/ru/index.html"
        sed -i 's|href="en/|href="/lab4/versions/'$VERSION_NAME'/en/|g' "versions/$VERSION_NAME/ru/index.html"
        sed -i 's|–í–µ—Ä—Å–∏—è: current|–í–µ—Ä—Å–∏—è: '$VERSION_NAME'|g' "versions/$VERSION_NAME/ru/index.html"
        
        # –ê–Ω–≥–ª–∏–π—Å–∫–∞—è –≤–µ—Ä—Å–∏—è
        sed -i 's|href="/lab4/|href="/lab4/versions/'$VERSION_NAME'/|g' "versions/$VERSION_NAME/en/index.html"
        sed -i 's|href="ru/|href="/lab4/versions/'$VERSION_NAME'/ru/|g' "versions/$VERSION_NAME/en/index.html"
        sed -i 's|Version: current|Version: '$VERSION_NAME'|g' "versions/$VERSION_NAME/en/index.html"
        
        echo "‚úÖ Links fixed"

    - name: Update versions.json
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üìù Adding version to versions.json: $VERSION_NAME"
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if [ ! -f versions.json ]; then
          echo '[]' > versions.json
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –ë–ï–ó —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö
        node -e "
        const fs = require('fs');
        let versions = [];
        
        try {
          versions = JSON.parse(fs.readFileSync('versions.json'));
          console.log('Found existing versions:', versions.length);
        } catch (e) {
          console.log('Starting with empty versions array');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏–∏ –Ω–µ—Ç
        if (!versions.find(v => v.name === '$VERSION_NAME')) {
          versions.unshift({
            name: '$VERSION_NAME',
            url: 'versions/$VERSION_NAME',
            date: new Date().toISOString(),
            description: 'Automated release'
          });
          console.log('‚úÖ Added version: $VERSION_NAME');
        } else {
          console.log('‚ÑπÔ∏è Version exists: $VERSION_NAME');
        }
        
        fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
        console.log('Total versions:', versions.length);
        "

    - name: Upload and deploy
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Success message
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo 'üéâ SUCCESS! Version deployed: $VERSION_NAME'
        echo 'üåê Site: ${{ steps.deployment.outputs.page_url }}'