name: Deploy to GitHub Pages on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Create version deployment
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "Deploying version: $VERSION_NAME"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¸
        mkdir -p "versions/$VERSION_NAME"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
        cp -r en ru index.html "versions/$VERSION_NAME/"
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑÑ‹Ð»ÐºÐ¸ Ð² HTML Ñ„Ð°Ð¹Ð»Ð°Ñ… Ð´Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð½Ñ‹Ñ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"/LAB4/|href=\"/LAB4/versions/$VERSION_NAME/|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"ru/|href=\"/LAB4/versions/$VERSION_NAME/ru/|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"en/|href=\"/LAB4/versions/$VERSION_NAME/en/|g" {} \;
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|Ð’ÐµÑ€ÑÐ¸Ñ: current|Ð’ÐµÑ€ÑÐ¸Ñ: $VERSION_NAME|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|Version: current|Version: $VERSION_NAME|g" {} \;

    - name: Update versions list
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ versions.json
        if [ -f versions.json ]; then
          node -e "
            const fs = require('fs');
            const versions = JSON.parse(fs.readFileSync('versions.json'));
            const newVersion = { name: '$VERSION_NAME', url: 'versions/$VERSION_NAME', date: new Date().toISOString() };
            
            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑ‘ ÐµÑ‰Ðµ Ð½ÐµÑ‚
            if (!versions.find(v => v.name === '$VERSION_NAME')) {
              versions.unshift(newVersion);
              fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
            }
          "
        else
          echo '[{"name": "'$VERSION_NAME'", "url": "versions/'$VERSION_NAME'", "date": "'$(date -I)'"}]' > versions.json
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Show deployment info
      run: |
        echo "âœ… Successfully deployed version: ${GITHUB_REF#refs/tags/}"
        echo "ðŸ“± Your site will be available at: https://${{ github.repository_owner }}.github.io/LAB4/"