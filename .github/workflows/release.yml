name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Debug - Show files
        run: |
          echo "ðŸ“ Current structure:"
          ls -la
          echo "ðŸ“ Versions folder:"
          ls -la versions/ || echo "No versions folder"
          
      - name: Create version with verification
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸš€ Deploying: $VERSION"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ
          mkdir -p "versions/$VERSION"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹
          echo "ðŸ“‹ Copying files..."
          cp -r en/ ru/ index.html "versions/$VERSION/"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¾ÑÑŒ
          echo "âœ… Files in versions/$VERSION/:"
          ls -la "versions/$VERSION/"
          
      - name: Fix HTML links
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸ”§ Fixing links for: $VERSION"
          
          # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸ Ð² HTML Ñ„Ð°Ð¹Ð»Ð°Ñ…
          sed -i 's|href="/lab4/|href="/lab4/versions/'$VERSION'/|g' "versions/$VERSION/ru/index.html"
          sed -i 's|href="/lab4/|href="/lab4/versions/'$VERSION'/|g' "versions/$VERSION/en/index.html"
          sed -i 's|href="en/|href="/lab4/versions/'$VERSION'/en/|g' "versions/$VERSION/ru/index.html"
          sed -i 's|href="ru/|href="/lab4/versions/'$VERSION'/ru/|g' "versions/$VERSION/en/index.html"
          
      - name: Update versions list
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸ“ Updating versions.json"
          
          if [ ! -f versions.json ]; then
            echo '[]' > versions.json
          fi
          
          node -e "
          const fs = require('fs');
          let versions = [];
          try {
            versions = JSON.parse(fs.readFileSync('versions.json'));
          } catch(e) {}
          
          if (!versions.find(v => v.name === '$VERSION')) {
            versions.unshift({
              name: '$VERSION',
              url: 'versions/$VERSION',
              date: new Date().toISOString()
            });
            console.log('âœ… Added version: $VERSION');
          }
          
          fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
          console.log('Total versions:', versions.length);
          "
          
      - uses: actions/upload-pages-artifact@v3
        with: { path: . }
      - uses: actions/deploy-pages@v4