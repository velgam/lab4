name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create version folder
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸš€ Deploying: $VERSION"
          
          # Create version folder
          mkdir -p "versions/$VERSION"
          cp -r en ru index.html "versions/$VERSION/"
          
      - name: Update versions.json - ADD NEW VERSION
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸ“ Adding version to list: $VERSION"
          
          # Create versions.json if doesn't exist
          if [ ! -f versions.json ]; then
            echo '[]' > versions.json
          fi
          
          # ADD version without replacing others
          node -e "
          const fs = require('fs');
          let versions = [];
          
          try {
            versions = JSON.parse(fs.readFileSync('versions.json'));
            console.log('Found existing versions:', versions.length);
          } catch (e) {
            console.log('Starting with empty versions array');
          }
          
          // Check if version already exists
          const existingIndex = versions.findIndex(v => v.name === '$VERSION');
          
          if (existingIndex === -1) {
            // ADD new version to the beginning
            versions.unshift({
              name: '$VERSION',
              url: 'versions/$VERSION', 
              date: new Date().toISOString(),
              description: 'Automated release'
            });
            console.log('âœ… ADDED new version: $VERSION');
          } else {
            // Update existing version (don't add duplicate)
            versions[existingIndex].date = new Date().toISOString();
            console.log('ðŸ”„ UPDATED existing version: $VERSION');
          }
          
          // Save ALL versions
          fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
          console.log('Total versions in list:', versions.length);
          console.log('All versions:', versions.map(v => v.name));
          "
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with: 
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Show success
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ðŸŽ‰ SUCCESS! Version $VERSION deployed"
          echo "ðŸ“Š Check all versions at: https://velgam.github.io/lab4/"