name: Deploy to GitHub Pages on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create version deployment
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "ğŸš€ Deploying version: $VERSION_NAME"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¸
        mkdir -p "versions/$VERSION_NAME"
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ
        cp -r en ru index.html "versions/$VERSION_NAME/"
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ² HTML Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ… Ğ´Ğ»Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"/LAB4/|href=\"/LAB4/versions/$VERSION_NAME/|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"ru/|href=\"/LAB4/versions/$VERSION_NAME/ru/|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|href=\"en/|href=\"/LAB4/versions/$VERSION_NAME/en/|g" {} \;
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|Ğ’ĞµÑ€ÑĞ¸Ñ: current|Ğ’ĞµÑ€ÑĞ¸Ñ: $VERSION_NAME|g" {} \;
        find "versions/$VERSION_NAME" -name "*.html" -exec sed -i "s|Version: current|Version: $VERSION_NAME|g" {} \;

    - name: Update versions list
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "ğŸ“ Updating versions list with: $VERSION_NAME"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ versions.json
        if [ -f versions.json ]; then
          node -e "
            const fs = require('fs');
            let versions = [];
            try {
              versions = JSON.parse(fs.readFileSync('versions.json'));
            } catch (e) {}
            
            // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ ĞµÑĞ»Ğ¸ ĞµÑ‘ ĞµÑ‰Ğµ Ğ½ĞµÑ‚
            if (!versions.find(v => v.name === '$VERSION_NAME')) {
              versions.unshift({
                name: '$VERSION_NAME', 
                url: 'versions/$VERSION_NAME', 
                date: new Date().toISOString(),
                description: 'Automated release'
              });
              fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
              console.log('âœ… Version added to versions.json');
            } else {
              console.log('â„¹ï¸ Version already exists in versions.json');
            }
          "
        else
          echo '[{"name": "'$VERSION_NAME'", "url": "versions/'$VERSION_NAME'", "date": "'$(date -I)'", "description": "First automated release"}]' > versions.json
          echo "âœ… Created versions.json with first version"
        fi
        
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ versions.json Ğ´Ğ»Ñ Ğ´ĞµĞ±Ğ°Ğ³Ğ°
        echo "ğŸ“„ Current versions.json:"
        cat versions.json

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Show deployment info
      run: |
        echo "âœ… Successfully deployed version: ${GITHUB_REF#refs/tags/}"
        echo "ğŸŒ Your site is available at: ${{ steps.deployment.outputs.page_url }}"