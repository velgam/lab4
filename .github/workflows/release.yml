name: Deploy to GitHub Pages on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Debug - Show current files
      run: |
        echo "üìÅ Current directory structure:"
        ls -la
        echo "üìÅ Versions folder:"
        ls -la versions/ || echo "No versions folder"

    - name: Create NEW version folder
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üöÄ Creating version: $VERSION_NAME"
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
        mkdir -p "versions/$VERSION_NAME"
        
        # –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
        cp -r en/ ru/ index.html "versions/$VERSION_NAME/"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å
        echo "‚úÖ Copied files to versions/$VERSION_NAME:"
        ls -la "versions/$VERSION_NAME/"

    - name: Fix HTML links for versioned pages
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üîß Fixing links for version: $VERSION_NAME"
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ —Ä—É—Å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏
        sed -i 's|href="/LAB4/|href="/LAB4/versions/'$VERSION_NAME'/|g' "versions/$VERSION_NAME/ru/index.html"
        sed -i 's|href="en/|href="/LAB4/versions/'$VERSION_NAME'/en/|g' "versions/$VERSION_NAME/ru/index.html"
        sed -i 's|–í–µ—Ä—Å–∏—è: current|–í–µ—Ä—Å–∏—è: '$VERSION_NAME'|g' "versions/$VERSION_NAME/ru/index.html"
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏  
        sed -i 's|href="/LAB4/|href="/LAB4/versions/'$VERSION_NAME'/|g' "versions/$VERSION_NAME/en/index.html"
        sed -i 's|href="ru/|href="/LAB4/versions/'$VERSION_NAME'/ru/|g' "versions/$VERSION_NAME/en/index.html"
        sed -i 's|Version: current|Version: '$VERSION_NAME'|g' "versions/$VERSION_NAME/en/index.html"
        
        echo "‚úÖ Links fixed for $VERSION_NAME"

    - name: Update versions.json AUTOMATICALLY
      run: |
        VERSION_NAME="${GITHUB_REF#refs/tags/}"
        echo "üìù Updating versions.json with: $VERSION_NAME"
        
        # –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π versions.json –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if [ ! -f versions.json ]; then
          echo '[]' > versions.json
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ versions.json
        node -e "
        const fs = require('fs');
        let versions = [];
        
        try {
          versions = JSON.parse(fs.readFileSync('versions.json'));
        } catch (e) {
          console.log('Starting with empty versions array');
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        versions = versions.filter(v => v.name !== '$VERSION_NAME');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –í –ù–ê–ß–ê–õ–û —Å–ø–∏—Å–∫–∞
        versions.unshift({
          name: '$VERSION_NAME',
          url: 'versions/$VERSION_NAME',
          date: new Date().toISOString(),
          description: 'Automated release'
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
        console.log('‚úÖ Successfully added $VERSION_NAME to versions.json');
        console.log('Total versions:', versions.length);
        "
        
        echo "üìÑ Final versions.json:"
        cat versions.json

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Show success message
      run: |
        echo 'üéâ SUCCESS! New version deployed: ${GITHUB_REF#refs/tags/}'
        echo 'üåê Your site: ${{ steps.deployment.outputs.page_url }}'
        echo 'üì± New version available at: ${{ steps.deployment.outputs.page_url }}versions/${GITHUB_REF#refs/tags/}/ru/'