name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ğŸš€ Deploying: $VERSION"
          
          # Create version folder
          mkdir -p "versions/$VERSION"
          cp -r en ru index.html "versions/$VERSION/"
          
          # Update versions.json
          if [ -f versions.json ]; then
            node -e "
            let fs = require('fs');
            let versions = JSON.parse(fs.readFileSync('versions.json'));
            if (!versions.find(v => v.name === '$VERSION')) {
              versions.unshift({
                name: '$VERSION',
                url: 'versions/$VERSION', 
                date: new Date().toISOString(),
                description: 'Automated release'
              });
              fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
              console.log('âœ… Added version: $VERSION');
              console.log('Total versions:', versions.length);
            } else {
              console.log('â„¹ï¸ Version exists: $VERSION');
            }
            "
          else
            echo "[{\"name\":\"$VERSION\",\"url\":\"versions/$VERSION\",\"date\":\"$(date)\",\"description\":\"First release\"}]" > versions.json
          fi
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with: 
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Show success
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ğŸ‰ SUCCESS! Version $VERSION deployed"
          echo "ğŸŒ Site: https://velgam.github.io/lab4/"